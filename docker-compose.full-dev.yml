# Compose file para desenvolvimento com todos os serviços (infra + quarkus em devmode + otel collector)
# Use: docker compose -f docker-compose.full-dev.yml up --build

services:
  keycloak:
    image: quay.io/keycloak/keycloak:23.0.0
    container_name: keycloak
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KC_DB=dev-file
    command: ["start-dev", "--import-realm"]
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    ports:
      - "8180:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/ready"]
      interval: 10s
      timeout: 5s
      retries: 5

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    ports:
      - "3000:3000"
    depends_on:
      - prometheus

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel-collector
    command: ["--config=/etc/otel-collector-config.yml"]
    volumes:
      - ./otel-collector-config.yml:/etc/otel-collector-config.yml:ro
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
    restart: unless-stopped

  quarkus-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: quarkus-dev
    environment:
      - QUARKUS_HTTP_PORT=8080
      - QUARKUS_PROFILE=dev
      - QUARKUS_DATASOURCE_JDBC_URL=jdbc:sqlite:/data/quarkus.db
      - QUARKUS_DATASOURCE_DB_KIND=sqlite
      - JAVA_OPTS=-Dquarkus.http.port=8080
      - QUARKUS_OPENTELEMETRY_TRACES_EXPORTER=otlp
      - QUARKUS_OPENTELEMETRY_TRACES_ENDPOINT=http://otel-collector:4318
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
      - OTEL_EXPORTER_OTLP_TRACES_ENDPOINT=http://otel-collector:4318
      - OTEL_RESOURCE_ATTRIBUTES=service.name=quarkus-dev
      - QUARKUS_OIDC_AUTH_SERVER_URL=http://localhost:8180/realms/cx-invest
      - QUARKUS_OIDC_CLIENT_ID=cx-invest-backend
      - QUARKUS_OIDC_CREDENTIALS_SECRET=secret
      - QUARKUS_OIDC_TLS_VERIFICATION=none
    volumes:
      - ./:/workspace:delegated
      - ~/.m2:/root/.m2
      - ./quarkus/data:/data
      - ./quarkus/imports.sql:/data/imports.sql:ro
    ports:
      - "8081:8080"  # host:container (ajuste se a porta estiver em uso)
      - "5005:5005"  # debug
    command: sh -c "chmod +x /workspace/mvnw || true; cd /workspace && QUARKUS_OPENTELEMETRY_TRACES_EXPORTER=otlp QUARKUS_OPENTELEMETRY_TRACES_ENDPOINT=http://otel-collector:4318 JAVA_TOOL_OPTIONS='-Dquarkus.opentelemetry.traces.exporter=otlp -Dquarkus.opentelemetry.traces.endpoint=http://otel-collector:4318' ./mvnw quarkus:dev -Dquarkus.http.host=0.0.0.0 -Dquarkus.live-reload.polling=true || mvn -f pom.xml -Dquarkus.opentelemetry.traces.exporter=otlp -Dquarkus.opentelemetry.traces.endpoint=http://otel-collector:4318 quarkus:dev -Dquarkus.http.host=0.0.0.0 -Dquarkus.live-reload.polling=true"
    depends_on:
      - keycloak
      - prometheus
      - otel-collector
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/q/health/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

# sem networks explícitas — o compose criará a rede default automaticamente

